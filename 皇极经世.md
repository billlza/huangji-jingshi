|  |
|:---|
| **\# 《皇极经世 · Web 版》技术设计文档（初版）** |
|  |
| **\## 0. 项目目标与边界** |
|  |
| **\### 目标** |
|  |
| 做一个网页版「皇极经世」系统： |
|  |
| \- 支持按 **\*\*公历时间 + 地理位置\*\*** 查询对应的「元 / 会 / 运 / 世 / 旬 / 年」「干支」「卦象」等结果。 |
| \- 查询同一时刻天空中太阳 / 月亮 / 行星的基本位置（至少：高度角 Alt、方位角 Az），用于前端星空图。 |
| \- 提供清晰的 HTTP API，方便后续接入 App / 小程序等。 |
|  |
| **\*\*技术路线：\*\*** |
|  |
| \- **\*\*后端 Rust\*\***：天文计算（方案 B：所有严肃运算在后端）、皇极经世推演逻辑、数据访问（从 Excel 导入的基础表）、用户 / 日志 / 授权等“正常后端活儿”（后期再加）。 |
| \- **\*\*前端 React\*\***（推荐 Next.js 或 Vite + React）：时间 + 位置的交互输入；调用 Rust API 并展示结果；根据后端返回的天空坐标绘制星空（后续再引入更高级的星图渲染库）。 |
|  |
| **\### 非目标（当前阶段不做）** |
|  |
| \- 不追求天文台级别的弧秒精度，只要对人眼观感合理即可； |
| \- 不做复杂的用户系统 / 支付系统，只预留结构； |
| \- 不一次性搞完所有宫位/卦位可视化，只先打通「时间 → 算法 → JSON → 前端展示」的完整链路。 |
|  |
| **\## 1. 总体架构** |
|  |
| **\### 1.1 目录结构（workspace）** |
|  |
| \`\`\` |
| huangji-jingshi-web/ |
| Cargo.toml \# Rust workspace |
| huangji_core/ \# 核心库：天文 + 皇极经世 |
| Cargo.toml |
| src/ |
| lib.rs |
| sky.rs \# 星空相关计算 |
| fortune.rs \# 皇极经世相关计算 |
| data.rs \# 数据模型与查询（后面补） |
| backend/ \# Axum HTTP 服务 |
| Cargo.toml |
| src/ |
| main.rs |
| tools/ |
| etl_excel/ \# （可选）Excel → JSON 的 ETL 小工具 |
| frontend/ \# React 前端（Vite/Next 任选） |
| package.json |
| src/ |
| App.tsx 或 pages/ |
| \`\`\` |
|  |
| **\### 1.2 技术栈版本建议** |
|  |
| \- Rust：stable 最新版本（用 rustup default stable） |
| \- 后端框架：axum 0.7 + tokio |
| \- 天文库（任选其一，后续对比）： |
| \- pracstro：紧凑天文库，适合算太阳/月亮/行星位置。 |
| \- astro：Meeus《Astronomical Algorithms》系列算法的实现，功能更全。 |
| \- aaplus：同样基于 Meeus 的 Rust 实现。 |
| \- Excel 解析（ETL 工具层）：最简单：Python + pandas，把 Excel 转成干净 JSON；后面爱干净可以再写个 Rust 版本的导入工具。 |
| \- 前端：先用 Vite + React + TS 起盘；未来如果要 SEO 再迁 Next.js |
| **\## 2. 数据层设计（Excel → 结构化数据）** |
|  |
| **\### 2.1 Excel 源数据观察（基于你发的表）** |
|  |
| 典型内容： |
|  |
| \- 换算关系：1 元 = 12 会；1 会 = 60 运；1 运 = 6 世；1 世 = 6 旬；1 旬 = 10 年。 |
| \- 会 / 运 / 世 / 旬 对应的卦名 + 公元区间，如「7会午 / 天风姤 / 1运 乾为天 / 2运 天山屯 / ...」，部分运后面还有（前xxxx–前yyyy）。 |
| \- 逐年干支 + 公元年数，如「干支（甲子、乙丑…）、公元年（-2636, -2635, ...）」。 |
|  |
| 需要 ETL 提取： |
|  |
| \- **\*\*EraSegment\*\***：一段时间（以年或更细）的 元/会/运/世/旬/卦 / 公元时间区间； |
| \- **\*\*YearMapping\*\***：单个公元年份 → 甲子干支 + 所属元/会/运/世/旬； |
| \- **\*\*衍生信息\*\***：历史事件说明、备注文字等。 |
|  |
| **\### 2.2 核心数据模型（Rust struct）** |
|  |
| 在 \`huangji_core/src/data.rs\` 里定义： |
|  |
| \`\`\`rust |
| use serde::{Deserialize, Serialize}; |
|  |
| /// 公元年份区间（闭区间或半闭半开，看你习惯） |
| \#\[derive(Debug, Clone, Serialize, Deserialize)\] |
| pub struct YearRange { |
| pub start_year: i32, // 允许负数，表示公元前 |
| pub end_year: i32, // 包含或不包含由你决定，建议 \[start, end\] |
| } |
|  |
| /// 一段“运”的元数据（可以细化到世/旬） |
| \#\[derive(Debug, Clone, Serialize, Deserialize)\] |
| pub struct EraSegment { |
| pub yuan: i32, |
| pub hui: i32, |
| pub yun: i32, |
| pub shi: Option\<i32\>, |
| pub xun: Option\<i32\>, |
|  |
| /// 会对应的地支，如 午、未 |
| pub hui_branch: Option\<String\>, |
|  |
| /// 该段代表性的卦象：会卦 / 运卦 / 世卦等 |
| pub hexagram_hui: Option\<String\>, |
| pub hexagram_yun: Option\<String\>, |
| pub hexagram_shi: Option\<String\>, |
|  |
| /// 覆盖的公元年份区间 |
| pub gregorian_range: YearRange, |
|  |
| /// 备注，比如 “天水讼（前1496-前1137）” |
| pub note: Option\<String\>, |
| } |
|  |
| /// 单年映射（可从 Excel 逐年表导出） |
| \#\[derive(Debug, Clone, Serialize, Deserialize)\] |
| pub struct YearMapping { |
| pub gregorian_year: i32, |
| pub ganzhi: String, // 甲子、乙丑... |
| pub yuan: i32, |
| pub hui: i32, |
| pub yun: i32, |
| pub shi: i32, |
| pub xun: i32, |
| } |
| \`\`\` |
|  |
| 先以“够用”为原则，表结构可迭代升级。 |
|  |
| **\### 2.3 ETL 流程（推荐第一版用 Python）** |
|  |
| \- 目标：把 Excel 转成 JSON，例如 \`data/era_segments.json\`（\`Vec\<EraSegment\>\`）和 \`data/year_mapping.json\`（\`Vec\<YearMapping\>\`）。 |
| \- 推荐脚本：\`tools/etl_excel/parse_huangji.py\`，用 pandas 读取 Excel，根据关键字/行号提取段，构造字典后导出 JSON。 |
| \- 生成的 JSON 放到 \`huangji_core/data/\`。 |
| \- 在 \`huangji_core::data\` 写 loader，使用 \`once_cell::sync::Lazy\` 和 \`RwLock\<Vec\<...\>\>\` 缓存，后端启动时 \`load_data_from_files("huangji_core/data")\`，失败就 panic，方便早期发现问题。 |
| \- 未来如需 Postgres，可用 DB 查询替换 Vec，接口保持不变。 |
|  |
| **\## 3. 皇极经世计算模块设计（fortune.rs）** |
| **\### 3.1 输入/输出结构** |
|  |
| \`\`\`rust |
| use chrono::{DateTime, Utc}; |
| use serde::{Deserialize, Serialize}; |
|  |
| \#\[derive(Debug, Clone, Serialize, Deserialize)\] |
| pub struct FortuneRequest { |
| pub datetime: DateTime\<Utc\>, |
| // 后续可以加入 location, timezone, 是否用真太阳时 等 |
| } |
|  |
| \#\[derive(Debug, Clone, Serialize, Deserialize)\] |
| pub struct FortuneResponse { |
| pub yuan: i32, |
| pub hui: i32, |
| pub yun: i32, |
| pub shi: i32, |
| pub xun: i32, |
| pub nian_ganzhi: String, |
| pub hexagram_major: String, |
| pub hexagram_minor: Option\<String\>, |
| pub note: String, |
| } |
| \`\`\` |
|  |
| **\### 3.2 推演流程（逻辑层）** |
|  |
| 1\. datetime*\_utc → 公历年 year：第一版简单取 \`datetime.year()\`，未来可按节气修正。* |
| *2. 查找 YearMapping：根据 year 找到 ganzhi / 元会运世旬；超出范围则报错或外推。* |
| *3. 查找 EraSegment：在区间内找到对应段，提取会卦/运卦/世卦等。* |
| *4. 汇总 FortuneResponse：hexagram\_*major 取主要卦（如运卦/会卦），hexagram*\_minor 放次要卦，note 带历史说明/备注。* |
|  |
| *伪代码示例展示查找、组合逻辑（略）。* |
|  |
| **\*\*TODO 列表（皇极部分）\*\*** |
|  |
| *- TODO-fortune-001：完整梳理 Excel 中“年 ↔ 元会运世旬/卦”的映射规则，并在 ETL 中固化；* |
| *- TODO-fortune-002：补充「按月/日/时」细化到更小粒度的模型；* |
| *- TODO-fortune-003：引入节气/真太阳时，修正「年界」划分。* |
|  |
| *\## 4. 星空计算模块设计（sky.rs）* |
|  |
| *\### 4.1 输入/输出结构* |
|  |
| *\`\`\`rust* |
| *use chrono::{DateTime, Utc};* |
| *use serde::{Deserialize, Serialize};* |
|  |
| *\#\[derive(Debug, Clone, Serialize, Deserialize)\]* |
| *pub struct SkyRequest {* |
| *pub datetime: DateTime*\<Utc\>*,* |
| *pub lat\_*deg: f64, // 纬度：北正南负 |
| pub lon_deg: f64, // 经度：东正西负 |
| } |
|  |
| **\#\[derive(Debug, Clone, Serialize, Deserialize)\]** |
| pub struct CelestialBody { |
| pub name: String, |
| pub alt_deg: f64, // 高度角 |
| pub az_deg: f64, // 方位角：0=北，90=东 |
| pub distance_au: Option\<f64\>, |
| } |
|  |
| **\#\[derive(Debug, Clone, Serialize, Deserialize)\]** |
| pub struct SkyResponse { |
| pub bodies: Vec\<CelestialBody\>, |
| pub note: String, |
| } |
| \`\`\` |
|  |
| **\### 4.2 选用天文 crate** |
|  |
| \- 推荐主库：**\*\*astro\*\***（功能全、文档好）；备选：pracstro、aaplus。 |
| \- \`huangji_core/Cargo.toml\` 示例依赖： |
|  |
| \`\`\`toml |
| \[dependencies\] |
| chrono = { version = "0.4", features = \["serde"\] } |
| serde = { version = "1.0", features = \["derive"\] } |
| astro = "2.0.0" |
| \`\`\` |
|  |
| **\### 4.3 算法流程（概略）** |
|  |
| 1\. datetime → 儒略日； |
| 2\. 用 astro 获取太阳、月亮、行星地心黄道坐标； |
| 3\. 坐标系转换：黄道 → 赤道 → 地平； |
| 4\. 本地地平坐标转 Alt/Az（考虑经纬度、恒星时）； |
| 5\. 对各天体重复，填充 \`SkyResponse\`。 |
|  |
| 伪代码示例展示了调用 astro 计算太阳 Alt/Az 的流程（略）。 |
|  |
| **\*\*TODO 列表（天文部分）\*\*** |
|  |
| \- TODO-sky-001：选定最终 crate，写出稳定的 \`compute_sky\`； |
| \- TODO-sky-002：返回体扩展到月亮 + 五大行星； |
| \- TODO-sky-003：增加「星空采样模式」，返回星点或第三方星图配置。 |
|  |
| **\## 5. 后端 HTTP API（Axum）** |
|  |
| **\### 5.1 Cargo 配置** |
|  |
| \`backend/Cargo.toml\` 依赖示例： |
|  |
| \`\`\`toml |
| \[package\] |
| name = "huangji_backend" |
| version = "0.1.0" |
| edition = "2021" |
|  |
| \[dependencies\] |
| axum = { version = "0.7", features = \["macros", "json"\] } |
| tokio = { version = "1.37", features = \["rt-multi-thread", "macros"\] } |
| serde = { version = "1.0", features = \["derive"\] } |
| serde_json = "1.0" |
| chrono = { version = "0.4", features = \["serde"\] } |
| tower = "0.4" |
| tower-http = { version = "0.5", features = \["cors", "trace"\] } |
| tracing = "0.1" |
| tracing-subscriber = { version = "0.3", features = \["fmt", "env-filter"\] } |
| huangji_core = { path = "../huangji_core" } |
| anyhow = "1" |
| \`\`\` |
|  |
| **\### 5.2 路由与 handler 设计** |
|  |
| 提供 3 个接口：\`GET /health\`、\`GET /api/fortune\`、\`GET /api/sky\`，以及便于前端的 \`GET /api/sky-and-fortune\`。示例 \`main.rs\` 展示了数据加载、路由、解析参数、错误处理和组合响应的流程。 |
|  |
| **\## 6. 前端 React 原型** |
|  |
| **\### 6.1 项目初始化** |
|  |
| \`\`\`bash |
| cd huangji-jingshi-web |
| npm create vite@latest frontend -- --template react-ts |
| cd frontend |
| npm install |
| \`\`\` |
|  |
| **\### 6.2 最小 UI：输入 + 调用后端** |
|  |
| \- 使用 React + TS + Vite，提供时间、经纬度输入。 |
| \- 请求 \`http://localhost:8080/api/sky-and-fortune\`，展示 JSON。 |
| \- 后续可用 Canvas/WebGL 绘制星空，叠加“皇极经世”扇区/宫位，添加时间滑块实现动态刷新。 |
|  |
| **\## 7. 开发里程碑与优先级** |
|  |
| 1\. **\*\*里程碑 1：打通最小链路（1–2 天）\*\*** |
| \- 创建 workspace；核心模块提供占位实现；后端 /health 正常；前端能调用 \`/api/sky-and-fortune\`。 |
| 2\. **\*\*里程碑 2：Excel → JSON → 皇极推演初版\*\*** |
| \- 编写 ETL 脚本生成 \`era_segments.json\`、\`year_mapping.json\`；核心数据加载；\`compute_fortune\` 用真实数据。 |
| 3\. **\*\*里程碑 3：天文计算真实化（方案 B 落地）\*\*** |
| \- 选定天文 crate；实现太阳 Alt/Az，再扩展月亮和行星。 |
| 4\. **\*\*里程碑 4：前端星空可视化\*\*** |
| \- 基于 \`SkyResponse\` 绘制简版星空，叠加宫位；时间滑块调用后端动态更新。 |
|  |
| **\## 8. 当前占位/风险点汇总** |
|  |
| \- **\*\*天文精度风险\*\***：不同 crate 精度不同；若需严谨可后续对比 JPL ephemeris。 |
| \- **\*\*Excel 结构不规整\*\***：ETL 需结合术数理解整理；建议同时编写 README 解释数学/术数含义。 |
| \- **\*\*时区 / 真太阳时 / 节气边界\*\***：第一版用公历年 + UTC；真太阳时与节气划界为后续提升方向。 |
