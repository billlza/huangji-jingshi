## 结论与方向

* 维持现有 d3-celestial 背景（真实随时间/地点旋转），新增一层“皇极星”叠加，不做投影重算。

* 数据放置为 GeoJSON（J2000 RA/Dec，度），通过前端 `/data/` 或后端 `/api/celestial/data/` 的 `cultures/` 前缀读取，保证与现有数据路径探测兼容。

## 数据准备

* 新增文件：`frontend/public/data/cultures/huangji-stars.json`

* 结构：GeoJSON `FeatureCollection`，每颗星 `Feature` 携带 `properties`（`name_cn,name_hj,hip,mag,gua,fenye,note,tags`）。

* 坐标规则：`geometry.coordinates = [RA_deg, Dec_deg]`；RA 以度（`(h + m/60 + s/3600) * 15`），Dec 以度（正负）。

* 若需要后端同源：在后端静态数据镜像目录添加同名文件（如 `backend/data/celestial/cultures/huangji-stars.json`），无需改后端代码（路由已允许 `cultures/*`）。

## 叠加绘制函数

* 在 `frontend/src/StarMap.tsx` 中，紧邻 `drawCn`/`drawStars` 定义，新增 `drawHjStars(base)`。

* 位置建议：在 `frontend/src/StarMap.tsx:188` 之后（与现有两个 draw\* 并列，便于调用）。

* 实现要点：

  * 读取：`const hj = await fetch(`${base}cultures/huangji-stars.json`).then(...)`

  * 使用 `(window.Celestial as any).add(hj, { ... })` 以 `type: 'point'` 添加。

  * 样式：整体金色系（与现 UI 协调），`size` 随 `mag` 缩放，`label` 取 `name_hj || name_cn`。

* 代码示例：

```ts
const drawHjStars = async (base: string) => {
  try {
    const hj = await fetch(`${base}cultures/huangji-stars.json`).then(r => r.ok ? r.json() : null);
    if (!hj || !window.Celestial || typeof (window.Celestial as any).add !== 'function') return;
    (window.Celestial as any).add(hj, {
      type: 'point',
      className: 'hj-star',
      style: { fill: '#ffd66b', opacity: 1 },
      size: (d: any) => {
        const mag = d.properties?.mag ?? 4;
        return Math.max(1.5, Math.pow(6 - mag, 0.6));
      },
      label: (d: any) => d.properties?.name_hj || d.properties?.name_cn,
      labelStyle: {
        fill: '#ffeaa7',
        font: "bold 11px '-apple-system','SF Pro Text','Segoe UI',Roboto,sans-serif"
      }
    });
  } catch {}
};
```

## 初始化接入

* 在首次渲染后的延迟加载段加入条件调用（与中国星官一致）：

* 现有调用：`frontend/src/StarMap.tsx:255`

* 修改为：

```ts
setTimeout(async () => {
  await ensureRendered();
  const base = rootRef.current ?? root;
  if (!isIau) {
    await drawCn(base);
    if (culture === 'hj') {
      await drawHjStars(base);
    }
  }
  await drawStars(base);
}, 800);
```

* 保持 `skyview({date,location,timezone})` 不变（`frontend/src/StarMap.tsx:203–209,224–244`），所有对象随时间/地点自动重投影。

## 交互增强（可选）

* 悬停/点击：渲染完成后查询 SVG 中 `.hj-star` 对应元素，显示 tooltip，内容取自 `properties`（卦象、分野、说明）。

* 过滤开关：在右上控制条新增“只看皇极星”选项，启用时将 `config.stars.show=false` 并隐藏中国星官层，仅保留皇极层。

* 时间动画：复用现有时间设置通道（`Celestial.skyview`），每秒推进 1 小时或 1 天；UI 上增加播放/暂停按钮。

## 精度策略

* 现在需要“千年演化”，为皇极星引入岁差/自行计算，将得出的 RA/Dec 动态传入叠加层（可考虑 `astronomia`/Meeus 算法）。

## 兼容性与副作用

* 数据路径兼容：读取 `${base}cultures/huangji-stars.json`，在 `/data/` 与 `/api/celestial/data/` 两种模式下均可正常命中。

* 性能影响可忽略：皇极星数量有限，`add(point)` 对 SVG 渲染压力很小。

* 风格一致性：色板与字号与现 UI 保持统一，不改动背景图层与行星重命名逻辑。

